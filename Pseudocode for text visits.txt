Pseudocode for parsing a text box


process_line():
  create tspan for each span in queue
  return line_height, first_span (ref to first tspan in line)

visit_p():
  for each span in p:
    iterate through span data
      add to queue if end of span reached before end of line
    once a full line is reached:
      line_height, first_span_in_line = process_line()
      update first_span_in_p
      p_height += line_height
  update first_span_in_p based on paragraph before spacing
  update p_height
  return p_height, first_span_in_p

visit_textarea():
  for each p in textarea:
    p_height, first_span_in_p = visit_p()
    on first, store ref to first_span_in_textarea
    text_height += p_height
    update first_span_in_p based on paragraph after spacing for p (not first)
    update text_height
  update first_span_in_textarea based on alignment of textarea, svg_h and text_height

Can easily add in other grammar elements (lists) based on this structure...